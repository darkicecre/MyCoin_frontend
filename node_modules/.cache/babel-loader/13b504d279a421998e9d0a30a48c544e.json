{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _invariant = require(\"@react-dnd/invariant\");\n\nvar _registryJs = require(\"../actions/registry.js\");\n\nvar _getNextUniqueIdJs = require(\"../utils/getNextUniqueId.js\");\n\nvar _interfacesJs = require(\"../interfaces.js\");\n\nvar _contractsJs = require(\"../contracts.js\");\n\nvar _asap = require(\"@react-dnd/asap\");\n\nfunction getNextHandlerId(role) {\n  const id = (0, _getNextUniqueIdJs).getNextUniqueId().toString();\n\n  switch (role) {\n    case _interfacesJs.HandlerRole.SOURCE:\n      return `S${id}`;\n\n    case _interfacesJs.HandlerRole.TARGET:\n      return `T${id}`;\n\n    default:\n      throw new Error(`Unknown Handler Role: ${role}`);\n  }\n}\n\nfunction parseRoleFromHandlerId(handlerId) {\n  switch (handlerId[0]) {\n    case 'S':\n      return _interfacesJs.HandlerRole.SOURCE;\n\n    case 'T':\n      return _interfacesJs.HandlerRole.TARGET;\n\n    default:\n      throw new Error(`Cannot parse handler ID: ${handlerId}`);\n  }\n}\n\nfunction mapContainsValue(map, searchValue) {\n  const entries = map.entries();\n  let isDone = false;\n\n  do {\n    const {\n      done,\n      value: [, value]\n    } = entries.next();\n\n    if (value === searchValue) {\n      return true;\n    }\n\n    isDone = !!done;\n  } while (!isDone);\n\n  return false;\n}\n\nclass HandlerRegistryImpl {\n  addSource(type, source) {\n    (0, _contractsJs).validateType(type);\n    (0, _contractsJs).validateSourceContract(source);\n    const sourceId = this.addHandler(_interfacesJs.HandlerRole.SOURCE, type, source);\n    this.store.dispatch((0, _registryJs).addSource(sourceId));\n    return sourceId;\n  }\n\n  addTarget(type, target) {\n    (0, _contractsJs).validateType(type, true);\n    (0, _contractsJs).validateTargetContract(target);\n    const targetId = this.addHandler(_interfacesJs.HandlerRole.TARGET, type, target);\n    this.store.dispatch((0, _registryJs).addTarget(targetId));\n    return targetId;\n  }\n\n  containsHandler(handler) {\n    return mapContainsValue(this.dragSources, handler) || mapContainsValue(this.dropTargets, handler);\n  }\n\n  getSource(sourceId) {\n    let includePinned = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    (0, _invariant).invariant(this.isSourceId(sourceId), 'Expected a valid source ID.');\n    const isPinned = includePinned && sourceId === this.pinnedSourceId;\n    const source = isPinned ? this.pinnedSource : this.dragSources.get(sourceId);\n    return source;\n  }\n\n  getTarget(targetId) {\n    (0, _invariant).invariant(this.isTargetId(targetId), 'Expected a valid target ID.');\n    return this.dropTargets.get(targetId);\n  }\n\n  getSourceType(sourceId) {\n    (0, _invariant).invariant(this.isSourceId(sourceId), 'Expected a valid source ID.');\n    return this.types.get(sourceId);\n  }\n\n  getTargetType(targetId) {\n    (0, _invariant).invariant(this.isTargetId(targetId), 'Expected a valid target ID.');\n    return this.types.get(targetId);\n  }\n\n  isSourceId(handlerId) {\n    const role = parseRoleFromHandlerId(handlerId);\n    return role === _interfacesJs.HandlerRole.SOURCE;\n  }\n\n  isTargetId(handlerId) {\n    const role = parseRoleFromHandlerId(handlerId);\n    return role === _interfacesJs.HandlerRole.TARGET;\n  }\n\n  removeSource(sourceId) {\n    (0, _invariant).invariant(this.getSource(sourceId), 'Expected an existing source.');\n    this.store.dispatch((0, _registryJs).removeSource(sourceId));\n    (0, _asap).asap(() => {\n      this.dragSources.delete(sourceId);\n      this.types.delete(sourceId);\n    });\n  }\n\n  removeTarget(targetId) {\n    (0, _invariant).invariant(this.getTarget(targetId), 'Expected an existing target.');\n    this.store.dispatch((0, _registryJs).removeTarget(targetId));\n    this.dropTargets.delete(targetId);\n    this.types.delete(targetId);\n  }\n\n  pinSource(sourceId) {\n    const source = this.getSource(sourceId);\n    (0, _invariant).invariant(source, 'Expected an existing source.');\n    this.pinnedSourceId = sourceId;\n    this.pinnedSource = source;\n  }\n\n  unpinSource() {\n    (0, _invariant).invariant(this.pinnedSource, 'No source is pinned at the time.');\n    this.pinnedSourceId = null;\n    this.pinnedSource = null;\n  }\n\n  addHandler(role, type, handler) {\n    const id = getNextHandlerId(role);\n    this.types.set(id, type);\n\n    if (role === _interfacesJs.HandlerRole.SOURCE) {\n      this.dragSources.set(id, handler);\n    } else if (role === _interfacesJs.HandlerRole.TARGET) {\n      this.dropTargets.set(id, handler);\n    }\n\n    return id;\n  }\n\n  constructor(store) {\n    this.types = new Map();\n    this.dragSources = new Map();\n    this.dropTargets = new Map();\n    this.pinnedSourceId = null;\n    this.pinnedSource = null;\n    this.store = store;\n  }\n\n}\n\nexports.HandlerRegistryImpl = HandlerRegistryImpl;","map":{"version":3,"mappings":";;;;;;AAC0B,cAAsB,kCAAtB;;AAMnB,eAAwB,oCAAxB;;AACyB,sBAA6B,yCAA7B;;AAUzB,iBAAkB,8BAAlB;;AAKA,gBAAiB,6BAAjB;;AACc,SAAiB,6BAAjB;;SAEZA,iBAAiBC,MAA2B;EACpD,MAAMC,EAAE,OAAGC,kBAAH,EAAkBA,eAAlB,GAAqBC,QAArB,EAAR;;EACA,QAAQH,IAAR;IACC,KAAKI,aAAW,YAAXA,CAAYC,MAAjB;MACC,OAAQ,IAAGJ,EAAE,EAAb;;IACD,KAAKG,aAAW,YAAXA,CAAYE,MAAjB;MACC,OAAQ,IAAGL,EAAE,EAAb;;;MAEA,MAAM,IAAIM,KAAJ,CAAW,yBAAwBP,IAAI,EAAvC,CAAN;EANF;AAQA;;SAEQQ,uBAAuBC,WAAmB;EAClD,QAAQA,SAAS,CAAC,CAAD,CAAjB;IACC,KAAK,GAAL;MACC,OAAOL,aAAW,YAAXA,CAAYC,MAAnB;;IACD,KAAK,GAAL;MACC,OAAOD,aAAW,YAAXA,CAAYE,MAAnB;;;MAEA,MAAM,IAAIC,KAAJ,CAAW,4BAA2BE,SAAS,EAA/C,CAAN;EANF;AAQA;;SAEQC,iBAAoBC,KAAqBC,aAAgB;EACjE,MAAMC,OAAO,GAAGF,GAAG,CAACE,OAAJF,EAAhB;EACA,IAAIG,MAAM,GAAG,KAAb;;KACG;IACF,MAAM;MACLC,IADK;MAELC,KAAK,KAAKA,KAAL;IAFA,IAGFH,OAAO,CAACI,IAARJ,EAHJ;;IAIA,IAAIG,KAAK,KAAKJ,WAAd,EAA2B;MAC1B,OAAO,IAAP;IACA;;IACDE,MAAM,KAAKC,IAAXD;EACA,UAASA;;EACV,OAAO,KAAP;AACA;;MAEYI,oBAAmB;EAYxBC,SAAS,CAACC,IAAD,EAAmBC,MAAnB,EAA+C;QAC9DC,cAAYA,aAACF;QACbG,cAAsBA,uBAACF;IAEvB,MAAMG,QAAQ,GAAG,KAAKC,UAAL,CAAgBrB,aAAW,YAAXA,CAAYC,MAA5B,EAAoCe,IAApC,EAA0CC,MAA1C,CAAjB;IACA,KAAKK,KAAL,CAAWC,QAAX,CAAmB,IAACR,WAAD,EAAUA,SAAV,CAAWK,QAAX,CAAnB;IACA,OAAOA,QAAP;EACA;;EAEMI,SAAS,CAACR,IAAD,EAAmBS,MAAnB,EAA+C;QAC9DP,cAAYA,aAACF,MAAM;QACnBU,cAAsBA,uBAACD;IAEvB,MAAME,QAAQ,GAAG,KAAKN,UAAL,CAAgBrB,aAAW,YAAXA,CAAYE,MAA5B,EAAoCc,IAApC,EAA0CS,MAA1C,CAAjB;IACA,KAAKH,KAAL,CAAWC,QAAX,CAAmB,IAACC,WAAD,EAAUA,SAAV,CAAWG,QAAX,CAAnB;IACA,OAAOA,QAAP;EACA;;EAEMC,eAAe,CAACC,OAAD,EAA4C;IACjE,OACCvB,gBAAgB,CAAC,KAAKwB,WAAN,EAAmBD,OAAnB,CAAhBvB,IACAA,gBAAgB,CAAC,KAAKyB,WAAN,EAAmBF,OAAnB,CAFjB;EAIA;;EAEMG,SAAS,CAACZ,QAAD,EAAsD;IAAA,IAAnCa,aAAmC,uEAAnB,KAAmB;QACrEC,YAASA,UAAC,KAAKC,UAAL,CAAgBf,QAAhB,GAA2B;IACrC,MAAMgB,QAAQ,GAAGH,aAAa,IAAIb,QAAQ,KAAK,KAAKiB,cAApD;IACA,MAAMpB,MAAM,GAAGmB,QAAQ,GAAG,KAAKE,YAAR,GAAuB,KAAKR,WAAL,CAAiBS,GAAjB,CAAqBnB,QAArB,CAA9C;IACA,OAAOH,MAAP;EACA;;EAEMuB,SAAS,CAACb,QAAD,EAA+B;QAC9CO,YAASA,UAAC,KAAKO,UAAL,CAAgBd,QAAhB,GAA2B;IACrC,OAAO,KAAKI,WAAL,CAAiBQ,GAAjB,CAAqBZ,QAArB,CAAP;EACA;;EAEMe,aAAa,CAACtB,QAAD,EAA+B;QAClDc,YAASA,UAAC,KAAKC,UAAL,CAAgBf,QAAhB,GAA2B;IACrC,OAAO,KAAKuB,KAAL,CAAWJ,GAAX,CAAenB,QAAf,CAAP;EACA;;EAEMwB,aAAa,CAACjB,QAAD,EAA8C;QACjEO,YAASA,UAAC,KAAKO,UAAL,CAAgBd,QAAhB,GAA2B;IACrC,OAAO,KAAKgB,KAAL,CAAWJ,GAAX,CAAeZ,QAAf,CAAP;EACA;;EAEMQ,UAAU,CAAC9B,SAAD,EAA6B;IAC7C,MAAMT,IAAI,GAAGQ,sBAAsB,CAACC,SAAD,CAAnC;IACA,OAAOT,IAAI,KAAKI,aAAW,YAAXA,CAAYC,MAA5B;EACA;;EAEMwC,UAAU,CAACpC,SAAD,EAA6B;IAC7C,MAAMT,IAAI,GAAGQ,sBAAsB,CAACC,SAAD,CAAnC;IACA,OAAOT,IAAI,KAAKI,aAAW,YAAXA,CAAYE,MAA5B;EACA;;EAEM2C,YAAY,CAACzB,QAAD,EAAyB;QAC3Cc,YAASA,UAAC,KAAKF,SAAL,CAAeZ,QAAf,GAA0B;IACpC,KAAKE,KAAL,CAAWC,QAAX,CAAmB,IAACsB,WAAD,EAAaA,YAAb,CAAczB,QAAd,CAAnB;QACA0B,OAAIA,WAAO;MACV,KAAKhB,WAAL,CAAiBiB,MAAjB,CAAwB3B,QAAxB;MACA,KAAKuB,KAAL,CAAWI,MAAX,CAAkB3B,QAAlB;IACA;EACD;;EAEM4B,YAAY,CAACrB,QAAD,EAAyB;QAC3CO,YAASA,UAAC,KAAKM,SAAL,CAAeb,QAAf,GAA0B;IACpC,KAAKL,KAAL,CAAWC,QAAX,CAAmB,IAACyB,WAAD,EAAaA,YAAb,CAAcrB,QAAd,CAAnB;IACA,KAAKI,WAAL,CAAiBgB,MAAjB,CAAwBpB,QAAxB;IACA,KAAKgB,KAAL,CAAWI,MAAX,CAAkBpB,QAAlB;EACA;;EAEMsB,SAAS,CAAC7B,QAAD,EAAyB;IACxC,MAAMH,MAAM,GAAG,KAAKe,SAAL,CAAeZ,QAAf,CAAf;QACAc,YAASA,UAACjB,QAAQ;IAElB,KAAKoB,cAAL,GAAsBjB,QAAtB;IACA,KAAKkB,YAAL,GAAoBrB,MAApB;EACA;;EAEMiC,WAAW,GAAS;QAC1BhB,YAASA,UAAC,KAAKI,cAAc;IAE7B,KAAKD,cAAL,GAAsB,IAAtB;IACA,KAAKC,YAAL,GAAoB,IAApB;EACA;;EAEOjB,UAAU,CACjBzB,IADiB,EAEjBoB,IAFiB,EAGjBa,OAHiB,EAIR;IACT,MAAMhC,EAAE,GAAGF,gBAAgB,CAACC,IAAD,CAA3B;IACA,KAAK+C,KAAL,CAAWQ,GAAX,CAAetD,EAAf,EAAmBmB,IAAnB;;IACA,IAAIpB,IAAI,KAAKI,aAAW,YAAXA,CAAYC,MAAzB,EAAiC;MAChC,KAAK6B,WAAL,CAAiBqB,GAAjB,CAAqBtD,EAArB,EAAyBgC,OAAzB;IACA,CAFD,MAEO,IAAIjC,IAAI,KAAKI,aAAW,YAAXA,CAAYE,MAAzB,EAAiC;MACvC,KAAK6B,WAAL,CAAiBoB,GAAjB,CAAqBtD,EAArB,EAAyBgC,OAAzB;IACA;;IACD,OAAOhC,EAAP;EACA;;cAzGkByB,OAAqB;IARlC,KACEqB,KADF,GACgD,IAAIS,GAAJ,EADhD;IAAA,KAEEtB,WAFF,GAEyC,IAAIsB,GAAJ,EAFzC;IAAA,KAGErB,WAHF,GAGyC,IAAIqB,GAAJ,EAHzC;IAAA,KAIEf,cAJF,GAIkC,IAJlC;IAAA,KAKEC,YALF,GAKsB,IALtB;IASL,KAAKhB,KAAL,GAAaA,KAAb;EACA;;AAV8B;;QAAnBR","names":["getNextHandlerId","role","id","getNextUniqueId","toString","HandlerRole","SOURCE","TARGET","Error","parseRoleFromHandlerId","handlerId","mapContainsValue","map","searchValue","entries","isDone","done","value","next","HandlerRegistryImpl","addSource","type","source","validateType","validateSourceContract","sourceId","addHandler","store","dispatch","addTarget","target","validateTargetContract","targetId","containsHandler","handler","dragSources","dropTargets","getSource","includePinned","invariant","isSourceId","isPinned","pinnedSourceId","pinnedSource","get","getTarget","isTargetId","getSourceType","types","getTargetType","removeSource","asap","delete","removeTarget","pinSource","unpinSource","set","Map"],"sources":["../../../src/classes/HandlerRegistryImpl.ts"],"sourcesContent":["import type { Store } from 'redux'\nimport { invariant } from '@react-dnd/invariant'\nimport {\n\taddSource,\n\taddTarget,\n\tremoveSource,\n\tremoveTarget,\n} from '../actions/registry.js'\nimport { getNextUniqueId } from '../utils/getNextUniqueId.js'\nimport type { State } from '../reducers/index.js'\nimport {\n\tDragSource,\n\tDropTarget,\n\tSourceType,\n\tTargetType,\n\tIdentifier,\n\tHandlerRole,\n\tHandlerRegistry,\n} from '../interfaces.js'\nimport {\n\tvalidateSourceContract,\n\tvalidateTargetContract,\n\tvalidateType,\n} from '../contracts.js'\nimport { asap } from '@react-dnd/asap'\n\nfunction getNextHandlerId(role: HandlerRole): string {\n\tconst id = getNextUniqueId().toString()\n\tswitch (role) {\n\t\tcase HandlerRole.SOURCE:\n\t\t\treturn `S${id}`\n\t\tcase HandlerRole.TARGET:\n\t\t\treturn `T${id}`\n\t\tdefault:\n\t\t\tthrow new Error(`Unknown Handler Role: ${role}`)\n\t}\n}\n\nfunction parseRoleFromHandlerId(handlerId: string) {\n\tswitch (handlerId[0]) {\n\t\tcase 'S':\n\t\t\treturn HandlerRole.SOURCE\n\t\tcase 'T':\n\t\t\treturn HandlerRole.TARGET\n\t\tdefault:\n\t\t\tthrow new Error(`Cannot parse handler ID: ${handlerId}`)\n\t}\n}\n\nfunction mapContainsValue<T>(map: Map<string, T>, searchValue: T) {\n\tconst entries = map.entries()\n\tlet isDone = false\n\tdo {\n\t\tconst {\n\t\t\tdone,\n\t\t\tvalue: [, value],\n\t\t} = entries.next()\n\t\tif (value === searchValue) {\n\t\t\treturn true\n\t\t}\n\t\tisDone = !!done\n\t} while (!isDone)\n\treturn false\n}\n\nexport class HandlerRegistryImpl implements HandlerRegistry {\n\tprivate types: Map<string, SourceType | TargetType> = new Map()\n\tprivate dragSources: Map<string, DragSource> = new Map()\n\tprivate dropTargets: Map<string, DropTarget> = new Map()\n\tprivate pinnedSourceId: string | null = null\n\tprivate pinnedSource: any = null\n\tprivate store: Store<State>\n\n\tpublic constructor(store: Store<State>) {\n\t\tthis.store = store\n\t}\n\n\tpublic addSource(type: SourceType, source: DragSource): string {\n\t\tvalidateType(type)\n\t\tvalidateSourceContract(source)\n\n\t\tconst sourceId = this.addHandler(HandlerRole.SOURCE, type, source)\n\t\tthis.store.dispatch(addSource(sourceId))\n\t\treturn sourceId\n\t}\n\n\tpublic addTarget(type: TargetType, target: DropTarget): string {\n\t\tvalidateType(type, true)\n\t\tvalidateTargetContract(target)\n\n\t\tconst targetId = this.addHandler(HandlerRole.TARGET, type, target)\n\t\tthis.store.dispatch(addTarget(targetId))\n\t\treturn targetId\n\t}\n\n\tpublic containsHandler(handler: DragSource | DropTarget): boolean {\n\t\treturn (\n\t\t\tmapContainsValue(this.dragSources, handler) ||\n\t\t\tmapContainsValue(this.dropTargets, handler)\n\t\t)\n\t}\n\n\tpublic getSource(sourceId: string, includePinned = false): DragSource {\n\t\tinvariant(this.isSourceId(sourceId), 'Expected a valid source ID.')\n\t\tconst isPinned = includePinned && sourceId === this.pinnedSourceId\n\t\tconst source = isPinned ? this.pinnedSource : this.dragSources.get(sourceId)\n\t\treturn source\n\t}\n\n\tpublic getTarget(targetId: string): DropTarget {\n\t\tinvariant(this.isTargetId(targetId), 'Expected a valid target ID.')\n\t\treturn this.dropTargets.get(targetId) as DropTarget\n\t}\n\n\tpublic getSourceType(sourceId: string): Identifier {\n\t\tinvariant(this.isSourceId(sourceId), 'Expected a valid source ID.')\n\t\treturn this.types.get(sourceId) as Identifier\n\t}\n\n\tpublic getTargetType(targetId: string): Identifier | Identifier[] {\n\t\tinvariant(this.isTargetId(targetId), 'Expected a valid target ID.')\n\t\treturn this.types.get(targetId) as Identifier | Identifier[]\n\t}\n\n\tpublic isSourceId(handlerId: string): boolean {\n\t\tconst role = parseRoleFromHandlerId(handlerId)\n\t\treturn role === HandlerRole.SOURCE\n\t}\n\n\tpublic isTargetId(handlerId: string): boolean {\n\t\tconst role = parseRoleFromHandlerId(handlerId)\n\t\treturn role === HandlerRole.TARGET\n\t}\n\n\tpublic removeSource(sourceId: string): void {\n\t\tinvariant(this.getSource(sourceId), 'Expected an existing source.')\n\t\tthis.store.dispatch(removeSource(sourceId))\n\t\tasap(() => {\n\t\t\tthis.dragSources.delete(sourceId)\n\t\t\tthis.types.delete(sourceId)\n\t\t})\n\t}\n\n\tpublic removeTarget(targetId: string): void {\n\t\tinvariant(this.getTarget(targetId), 'Expected an existing target.')\n\t\tthis.store.dispatch(removeTarget(targetId))\n\t\tthis.dropTargets.delete(targetId)\n\t\tthis.types.delete(targetId)\n\t}\n\n\tpublic pinSource(sourceId: string): void {\n\t\tconst source = this.getSource(sourceId)\n\t\tinvariant(source, 'Expected an existing source.')\n\n\t\tthis.pinnedSourceId = sourceId\n\t\tthis.pinnedSource = source\n\t}\n\n\tpublic unpinSource(): void {\n\t\tinvariant(this.pinnedSource, 'No source is pinned at the time.')\n\n\t\tthis.pinnedSourceId = null\n\t\tthis.pinnedSource = null\n\t}\n\n\tprivate addHandler(\n\t\trole: HandlerRole,\n\t\ttype: SourceType | TargetType,\n\t\thandler: DragSource | DropTarget,\n\t): string {\n\t\tconst id = getNextHandlerId(role)\n\t\tthis.types.set(id, type)\n\t\tif (role === HandlerRole.SOURCE) {\n\t\t\tthis.dragSources.set(id, handler as DragSource)\n\t\t} else if (role === HandlerRole.TARGET) {\n\t\t\tthis.dropTargets.set(id, handler as DropTarget)\n\t\t}\n\t\treturn id\n\t}\n}\n"]},"metadata":{},"sourceType":"script"}